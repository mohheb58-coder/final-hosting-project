<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Tahoma, Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 25%, #4ECDC4 50%, #95E1D3 75%, #FF6B9D 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        h1, h2 {
            color: #FF6B6B;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-size: 28px;
        }
        .btn {
            background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            width: calc(50% - 20px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
            font-weight: bold;
        }
        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.6);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
        }
        .btn-success {
            background: linear-gradient(135deg, #FFE66D 0%, #FFA500 100%);
            box-shadow: 0 5px 15px rgba(255, 230, 109, 0.4);
            color: #333;
        }
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(255, 230, 109, 0.6);
        }
        .btn-small {
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .hidden {
            display: none !important;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .select-row {
            display: flex;
            gap: 15px;
        }
        .select-row .form-group {
            flex: 1;
        }
        .student-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .student-name {
            flex: 1;
            font-size: 14px;
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .emoji-btn:hover {
            transform: scale(1.2);
        }
        .emoji-btn.absent {
            filter: grayscale(100%);
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6B9D;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .class-header {
            background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            font-size: 18px;
            border-bottom: 4px solid #A0506C;
        }
        .absence-list {
            padding: 10px 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 15px;
            border-right: 4px solid #FF6B9D;
        }
        .no-absence {
            padding: 15px 20px;
            background: #d4edda;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #155724;
            font-weight: bold;
            text-align: center;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-right: 4px solid #FF6B9D;
        }
        .stat-card h3 {
            color: #FF6B6B;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bar-label {
            min-width: 150px;
            font-size: 14px;
        }
        .bar-visual {
            flex: 1;
            height: 30px;
            background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%);
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-weight: bold;
        }
        .date-input {
            cursor: pointer;
            background: white !important;
        }
        .date-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .date-picker-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            margin: auto;
        }
        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .date-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        .date-btn:hover {
            background: #FF6B9D;
            color: white;
            border-color: #FF6B9D;
        }
    </style>
</head>
<body>
    <!-- Date Picker Modal -->
    <div id="datePickerModal" class="date-picker-modal">
        <div class="date-picker-content">
            <div class="date-picker-header">
                <h3 style="margin: 0; color: #FF6B6B;">Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®</h3>
                <button onclick="closeDatePicker()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
            </div>
            <div class="form-group">
                <label>Ø³Ø§Ù„:</label>
                <select id="yearSelect" onchange="updateMonthPicker()">
                    <option value="1403">1403</option>
                    <option value="1404">1404</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ù…Ø§Ù‡:</label>
                <div class="date-picker-grid" id="monthGrid"></div>
            </div>
            <div class="form-group">
                <label>Ø±ÙˆØ²:</label>
                <div class="date-picker-grid" id="dayGrid"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
        <div id="homePage">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <img src="https://i.ibb.co/rGr1Fx6J/image.jpg" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
                <div style="flex: 1; text-align: center;">
                    <h1 style="margin: 0;">Ø³ÛŒØ³ØªÙ… Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</h1>
                    <h2 style="margin: 10px 0;">Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ</h2>
                </div>
                <img src="https://i.ibb.co/LD1m3s5k/image.jpg" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
            </div>
            <div class="button-group">
                <button class="btn" onclick="showTeacherPanel()">ÙˆØ±ÙˆØ¯ Ù…Ø¹Ù„Ù…</button>
                <button class="btn btn-secondary" onclick="showManagerLogin()">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± -->
        <div id="managerLogin" class="hidden">
            <h2>ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h2>
            <div class="form-group">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                <input type="password" id="managerPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            <div id="loginError" class="message error hidden">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!</div>
            <div class="button-group">
                <button class="btn btn-success" onclick="checkManagerPassword()">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù… -->
        <div id="teacherPanel" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <img src="https://i.ibb.co/rGr1Fx6J/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
                <h2 style="margin: 0; flex: 1; text-align: center;">Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ</h2>
                <img src="https://i.ibb.co/LD1m3s5k/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
            </div>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÛŒÙ‡:</label>
                    <select id="gradeSelect" onchange="loadStudents()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                        <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                        <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³:</label>
                    <select id="classSelect" onchange="loadStudents()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ù…Ø¹Ù„Ù…:</label>
                <input type="text" id="teacherName" placeholder="Ù†Ø§Ù… Ù…Ø¹Ù„Ù…" readonly style="background: #f0f0f0;">
            </div>
            <div id="classInfo" class="message info hidden" style="text-align: center;">
                ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†: <span id="studentCount">0</span> Ù†ÙØ±
            </div>
            <div id="studentList" class="student-list"></div>
            <div id="teacherMessage" class="hidden"></div>
            <div class="button-group">
                <button class="btn" onclick="noAbsent()" id="noAbsentBtn">ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…</button>
                <button class="btn btn-success" onclick="submitAbsence()" id="submitBtn">Ø«Ø¨Øª ØºÛŒØ¨Øª</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± -->
        <div id="managerPanel" class="hidden">
            <h2>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <div class="button-group">
                <button class="btn" onclick="showDailyReport()">Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²</button>
                <button class="btn" onclick="showFullReport()">Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„</button>
                <button class="btn btn-secondary" onclick="showSearchPanel()">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</button>
                <button class="btn" onclick="showStatistics()">Ø¢Ù…Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±</button>
                <button class="btn btn-success" onclick="showAddStudent()">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² -->
        <div id="dailyReport" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <img src="https://i.ibb.co/rGr1Fx6J/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
                <h2 style="margin: 0; flex: 1; text-align: center;">Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ø§Ù…Ø±ÙˆØ²</h2>
                <img src="https://i.ibb.co/LD1m3s5k/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
            </div>
            <div id="dailyReportDate" style="text-align: center; color: #FF6B6B; font-weight: bold; font-size: 16px; margin-bottom: 15px;"></div>
            <div id="dailyReportContent"></div>
            <div class="button-group">
                <button class="btn btn-success btn-small" onclick="copyDailyReport()">Ú©Ù¾ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒØ§</button>
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ -->
        <div id="fullReport" class="hidden">
            <h2>Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„</h2>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="fromDate" class="date-input" placeholder="1403/08/01" readonly onclick="showDatePicker('fromDate')">
                </div>
                <div class="form-group">
                    <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="toDate" class="date-input" placeholder="1403/08/30" readonly onclick="showDatePicker('toDate')">
                </div>
            </div>
            <button class="btn btn-success" onclick="loadFullReport()">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
            <div id="fullReportContent"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
        <div id="searchPanel" class="hidden">
            <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²:</label>
                <input type="text" id="searchName" placeholder="Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
            </div>
            <div class="select-row">
                <div class="form-group">
                    <label>Ù¾Ø§ÛŒÙ‡:</label>
                    <select id="searchGrade">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                        <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                        <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ú©Ù„Ø§Ø³:</label>
                    <select id="searchClass">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="searchFromDate" class="date-input" placeholder="1403/08/01" readonly onclick="showDatePicker('searchFromDate')">
                </div>
                <div class="form-group">
                    <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="searchToDate" class="date-input" placeholder="1403/08/30" readonly onclick="showDatePicker('searchToDate')">
                </div>
            </div>
            <button class="btn btn-success" onclick="advancedSearch()">Ø¬Ø³ØªØ¬Ùˆ</button>
            <div id="searchResult"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ø¢Ù…Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± -->
        <div id="statisticsPanel" class="hidden">
            <h2>Ø¢Ù…Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± ØºÛŒØ¨Øªâ€ŒÙ‡Ø§</h2>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="statFromDate" class="date-input" placeholder="1403/08/01" readonly onclick="showDatePicker('statFromDate')">
                </div>
                <div class="form-group">
                    <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="statToDate" class="date-input" placeholder="1403/08/30" readonly onclick="showDatePicker('statToDate')">
                </div>
            </div>
            <button class="btn btn-success" onclick="loadStatistics()">Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±</button>
            <div id="statisticsContent"></div>
            <div class="button-group">
                <button class="btn btn-success btn-small" onclick="exportToExcel()">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</button>
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² -->
        <div id="addStudentPanel" class="hidden">
            <h2>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h2>
            <div class="form-group">
                <label>Ù†Ø§Ù…:</label>
                <input type="text" id="newStudentName">
            </div>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                <input type="text" id="newStudentFamily">
            </div>
            <div class="form-group">
                <label>Ù¾Ø§ÛŒÙ‡:</label>
                <select id="newStudentGrade">
                    <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                    <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                    <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ú©Ù„Ø§Ø³:</label>
                <select id="newStudentClass">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ù…Ø¹Ù„Ù…:</label>
                <input type="text" id="newStudentTeacher" placeholder="Ù†Ø§Ù… Ù…Ø¹Ù„Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
            </div>
            <div id="addStudentMessage" class="hidden"></div>
            <div class="button-group">
                <button class="btn btn-success" onclick="addStudent()">Ø«Ø¨Øª</button>
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>
    </div>

    <script>
        // URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Google Apps Script
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxJig2TKLfOmMxgYmZCd0QtaDqdRBK-95p85cLRmMf1c_GmH9LEQu7X0XxiLDW9QW7AHg/exec';
        
        let students = [];
        let currentAbsent = new Set();
        let currentStatistics = null;
        let currentDatePickerTarget = null;

        const persianMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 
                              'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];

        window.addEventListener('load', () => {
            fetchStudents();
            initializeDatePicker();
        });

        function initializeDatePicker() {
            const monthGrid = document.getElementById('monthGrid');
            persianMonths.forEach((month, index) => {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.textContent = month;
                btn.onclick = () => selectMonth(index + 1);
                monthGrid.appendChild(btn);
            });
        }

        function showDatePicker(targetId) {
            currentDatePickerTarget = targetId;
            document.getElementById('datePickerModal').style.display = 'flex';
            updateMonthPicker();
        }

        function closeDatePicker() {
            document.getElementById('datePickerModal').style.display = 'none';
        }

        function updateMonthPicker() {
            // Reset day grid
            document.getElementById('dayGrid').innerHTML = '';
        }

        function selectMonth(month) {
            const dayGrid = document.getElementById('dayGrid');
            dayGrid.innerHTML = '';
            
            const daysInMonth = month <= 6 ? 31 : (month <= 11 ? 30 : 29);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.textContent = day;
                btn.onclick = () => selectDay(month, day);
                dayGrid.appendChild(btn);
            }
        }

        function selectDay(month, day) {
            const year = document.getElementById('yearSelect').value;
            const formattedDate = `${year}/${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
            
            document.getElementById(currentDatePickerTarget).value = formattedDate;
            closeDatePicker();
        }

        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({action, ...data})
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±:', error);
                return {success: false, message: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'};
            }
        }

        async function fetchStudents() {
            const result = await callAPI('getStudents');
            if (result.success && result.data) {
                students = result.data;
            }
        }

        function showHome() {
            hideAll();
            document.getElementById('homePage').classList.remove('hidden');
        }

        function showTeacherPanel() {
            hideAll();
            document.getElementById('teacherPanel').classList.remove('hidden');
        }

        function showManagerLogin() {
            hideAll();
            document.getElementById('managerLogin').classList.remove('hidden');
            document.getElementById('managerPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        function showManagerPanel() {
            hideAll();
            document.getElementById('managerPanel').classList.remove('hidden');
        }

        function showDailyReport() {
            hideAll();
            document.getElementById('dailyReport').classList.remove('hidden');
            loadDailyReport();
        }

        function showFullReport() {
            hideAll();
            document.getElementById('fullReport').classList.remove('hidden');
        }

        function showSearchPanel() {
            hideAll();
            document.getElementById('searchPanel').classList.remove('hidden');
        }

        function showStatistics() {
            hideAll();
            document.getElementById('statisticsPanel').classList.remove('hidden');
        }

        function showAddStudent() {
            hideAll();
            document.getElementById('addStudentPanel').classList.remove('hidden');
        }

        function hideAll() {
            const pages = ['homePage', 'managerLogin', 'teacherPanel', 'managerPanel', 
                          'dailyReport', 'fullReport', 'searchPanel', 'addStudentPanel', 'statisticsPanel'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        function checkManagerPassword() {
            const password = document.getElementById('managerPassword').value;
            if (password === '2225') {
                showManagerPanel();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function loadStudents() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            
            if (!grade || !classNum) return;

            const filtered = students.filter(s => s.grade === grade && s.class === classNum);
            filtered.sort((a, b) => a.family.localeCompare(b.family, 'fa'));
            
            const listDiv = document.getElementById('studentList');
            currentAbsent.clear();
            
            getClassInfo(grade, classNum);
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p class="message info">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }
            
            listDiv.innerHTML = filtered.map((s, i) => `
                <div class="student-item">
                    <span class="student-name">${i + 1}. ${s.name} ${s.family}</span>
                    <button class="emoji-btn" id="emoji${i}" onclick="toggleAbsent(${i}, '${s.name}', '${s.family}')">ğŸ™‹â€â™‚ï¸</button>
                </div>
            `).join('');
        }

        async function getClassInfo(grade, classNum) {
            const result = await callAPI('getClassInfo', {grade, class: classNum});
            
            if (result.success && result.data) {
                const teacherInput = document.getElementById('teacherName');
                const classInfo = document.getElementById('classInfo');
                const studentCount = document.getElementById('studentCount');
                
                teacherInput.value = result.data.teacher || '';
                studentCount.textContent = result.data.studentCount;
                classInfo.classList.remove('hidden');
            }
        }

        function toggleAbsent(index, name, family) {
            const btn = document.getElementById('emoji' + index);
            const key = name + ' ' + family;
            
            if (currentAbsent.has(key)) {
                currentAbsent.delete(key);
                btn.textContent = 'ğŸ™‹â€â™‚ï¸';
                btn.classList.remove('absent');
            } else {
                currentAbsent.add(key);
                btn.textContent = 'ğŸ™';
                btn.classList.add('absent');
            }
        }

        async function noAbsent() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            const teacher = document.getElementById('teacherName').value;

            if (!grade || !classNum || !teacher) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            document.getElementById('noAbsentBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;

            const today = new Date().toLocaleDateString('fa-IR');
            const checkResult = await callAPI('checkDuplicateSubmission', {
                date: today,
                grade: grade,
                class: classNum
            });

            if (checkResult.data && checkResult.data.isDuplicate) {
                showMessage('teacherMessage', 'Ú©Ù„Ø§Ø³ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ØŒ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                return;
            }

            const result = await callAPI('submitAbsence', {
                date: today,
                grade: grade,
                class: classNum,
                teacher: teacher,
                time: new Date().toLocaleTimeString('fa-IR'),
                students: []
            });

            if (result.success) {
                showMessage('teacherMessage', 'ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ (ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…) âœ…', 'success');
                setTimeout(() => {
                    showHome();
                }, 2000);
            } else {
                showMessage('teacherMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
            }
        }

        async function submitAbsence() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            const teacher = document.getElementById('teacherName').value;

            if (!grade || !classNum || !teacher) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            if (currentAbsent.size === 0) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ØºØ§ÛŒØ¨ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯ ÛŒØ§ "ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            document.getElementById('noAbsentBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;

            const today = new Date().toLocaleDateString('fa-IR');
            const checkResult = await callAPI('checkDuplicateSubmission', {
                date: today,
                grade: grade,
                class: classNum
            });

            if (checkResult.data && checkResult.data.isDuplicate) {
                showMessage('teacherMessage', 'Ú©Ù„Ø§Ø³ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ØŒ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                return;
            }

            const result = await callAPI('submitAbsence', {
                date: today,
                grade: grade,
                class: classNum,
                teacher: teacher,
                time: new Date().toLocaleTimeString('fa-IR'),
                students: Array.from(currentAbsent)
            });

            if (result.success) {
                showMessage('teacherMessage', 'ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
                setTimeout(() => {
                    showHome();
                }, 2000);
            } else {
                showMessage('teacherMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
            }
        }

        function showMessage(elementId, text, type) {
            const msg = document.getElementById(elementId);
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.classList.remove('hidden');
        }

        async function loadDailyReport() {
            const contentDiv = document.getElementById('dailyReportContent');
            const dateDiv = document.getElementById('dailyReportDate');
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const today = new Date().toLocaleDateString('fa-IR');
            dateDiv.textContent = `ğŸ“… ØªØ§Ø±ÛŒØ®: ${today}`;
            
            const result = await callAPI('getDailyAbsences', {date: today});

            if (!result.success || !result.data || result.data.length === 0) {
                contentDiv.innerHTML = '<p class="message info">Ø§Ù…Ø±ÙˆØ² ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            const todayAbsences = result.data;
            todayAbsences.sort((a, b) => {
                const gradeOrder = {Ø§ÙˆÙ„: 1, Ø¯ÙˆÙ…: 2, Ø³ÙˆÙ…: 3};
                if (gradeOrder[a.grade] !== gradeOrder[b.grade]) {
                    return gradeOrder[a.grade] - gradeOrder[b.grade];
                }
                return parseInt(a.class) - parseInt(b.class);
            });

            let html = '';
            
            todayAbsences.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                html += `<div class="class-header">Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class} - ${genderIcon} ${a.teacher} - â° Ø³Ø§Ø¹Øª ${a.time}</div>`;
                
                if (a.students.length > 0) {
                    html += `<div class="absence-list">`;
                    a.students.forEach((s, i) => {
                        html += `<div style="padding: 5px 0;">${i + 1}. ${s}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="no-absence">âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…</div>`;
                }
            });
            
            const totalAbsent = todayAbsences.reduce((sum, a) => sum + a.students.length, 0);
            html += `<div style="background: #FFE66D; padding: 15px; border-radius: 10px; 
                     text-align: center; font-weight: bold; margin-top: 20px; font-size: 18px;">`;
            html += `ğŸ“Š Ø¬Ù…Ø¹ Ú©Ù„ ØºØ§ÛŒØ¨ÛŒÙ†: ${totalAbsent} Ù†ÙØ±`;
            html += `</div>`;

            contentDiv.innerHTML = html;
        }

        async function copyDailyReport() {
            const today = new Date().toLocaleDateString('fa-IR');
            const result = await callAPI('getDailyAbsences', {date: today});
            
            if (!result.success || !result.data || result.data.length === 0) {
                alert('Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return;
            }

            const todayAbsences = result.data;
            todayAbsences.sort((a, b) => {
                const gradeOrder = {Ø§ÙˆÙ„: 1, Ø¯ÙˆÙ…: 2, Ø³ÙˆÙ…: 3};
                if (gradeOrder[a.grade] !== gradeOrder[b.grade]) {
                    return gradeOrder[a.grade] - gradeOrder[b.grade];
                }
                return parseInt(a.class) - parseInt(b.class);
            });
            
            let text = `ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ\n`;
            text += `ğŸ“… ØªØ§Ø±ÛŒØ®: ${today}\n`;
            text += `${'â•'.repeat(40)}\n\n`;
            
            let totalAbsent = 0;
            
            todayAbsences.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                text += `â—‰ Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class} - ${genderIcon} ${a.teacher}\n`;
                text += `${'-'.repeat(40)}\n`;
                
                if (a.students.length > 0) {
                    totalAbsent += a.students.length;
                    a.students.forEach((s, i) => {
                        text += `   ${i + 1}. ${s}\n`;
                    });
                } else {
                    text += `   âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…\n`;
                }
                
                text += `\n`;
            });
            
            text += `${'â•'.repeat(40)}\n`;
            text += `ğŸ“Š Ø¬Ù…Ø¹ Ú©Ù„ ØºØ§ÛŒØ¨ÛŒÙ†: ${totalAbsent} Ù†ÙØ±\n`;
            text += `${'â•'.repeat(40)}`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§ÙˆÙ„ÛŒØ§ Ú©Ù¾ÛŒ Ø´Ø¯!');
                }).catch(err => {
                    fallbackCopyText(text);
                });
            } else {
                fallbackCopyText(text);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§ÙˆÙ„ÛŒØ§ Ú©Ù¾ÛŒ Ø´Ø¯!');
            } catch (err) {
                alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
            }
            document.body.removeChild(textArea);
        }

        async function loadFullReport() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const contentDiv = document.getElementById('fullReportContent');

            if (!fromDate || !toDate) {
                contentDiv.innerHTML = '<p class="message error">Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>';
                return;
            }

            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const result = await callAPI('getAbsencesByDate', {
                fromDate: fromDate,
                toDate: toDate
            });

            if (!result.success || !result.data || result.data.length === 0) {
                contentDiv.innerHTML = '<p class="message info">Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            let html = '';
            
            result.data.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                html += `<div class="class-header">${a.date} - Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class} - ${genderIcon} ${a.teacher} - Ø³Ø§Ø¹Øª ${a.time}</div>`;
                
                if (a.students.length > 0) {
                    html += `<div class="absence-list">`;
                    a.students.forEach((s, i) => {
                        html += `<div style="padding: 5px 0;">${i + 1}. ${s}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="no-absence">âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…</div>`;
                }
            });

            contentDiv.innerHTML = html;
        }

        async function advancedSearch() {
            const searchName = document.getElementById('searchName').value.trim();
            const searchGrade = document.getElementById('searchGrade').value;
            const searchClass = document.getElementById('searchClass').value;
            const searchFromDate = document.getElementById('searchFromDate').value;
            const searchToDate = document.getElementById('searchToDate').value;
            const resultDiv = document.getElementById('searchResult');

            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p></div>';

            const result = await callAPI('advancedSearch', {
                name: searchName,
                grade: searchGrade,
                classNum: searchClass,
                fromDate: searchFromDate,
                toDate: searchToDate
            });

            if (!result.success || !result.data || result.data.length === 0) {
                resultDiv.innerHTML = '<p class="message info">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            let html = `<div class="stat-card">`;
            html += `<h3>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (${result.data.length} Ù…ÙˆØ±Ø¯)</h3>`;
            html += '<div style="line-height: 1.8;">';
            
            result.data.forEach((a, i) => {
                html += `<div style="padding: 10px; background: #f9f9f9; 
                         border-radius: 8px; margin: 10px 0; border-right: 4px solid #FF6B9D;">`;
                html += `<strong>${i + 1}.</strong> ${a.name} - Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class}<br>`;
                html += `ØªØ§Ø±ÛŒØ®: ${a.date} - Ù…Ø¹Ù„Ù…: ${a.teacher}`;
                html += `</div>`;
            });
            
            html += '</div></div>';
            resultDiv.innerHTML = html;
        }

        async function loadStatistics() {
            const fromDate = document.getElementById('statFromDate').value;
            const toDate = document.getElementById('statToDate').value;
            const contentDiv = document.getElementById('statisticsContent');

            if (!fromDate || !toDate) {
                contentDiv.innerHTML = '<p class="message error">Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>';
                return;
            }

            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const result = await callAPI('getAbsenceStatistics', {
                fromDate: fromDate,
                toDate: toDate
            });

            if (!result.success || !result.data) {
                contentDiv.innerHTML = '<p class="message error">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±</p>';
                return;
            }

            currentStatistics = result.data;
            displayStatistics(result.data);
        }

        function displayStatistics(data) {
            const contentDiv = document.getElementById('statisticsContent');
            let html = '';

            // Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØºÛŒØ¨Øª
            if (data.students && data.students.length > 0) {
                html += `<div class="stat-card">`;
                html += `<h3>ğŸ”´ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØºÛŒØ¨Øª</h3>`;
                html += `<div class="bar-chart">`;
                
                const topStudents = data.students.slice(0, 10);
                const maxCount = topStudents[0].count;
                
                topStudents.forEach((s, i) => {
                    const width = (s.count / maxCount) * 100;
                    html += `<div class="bar-item">`;
                    html += `<div class="bar-label">${i + 1}. ${s.name}</div>`;
                    html += `<div class="bar-visual" style="width: ${width}%">${s.count} Ø±ÙˆØ²</div>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            }

            // Ù†Ù…ÙˆØ¯Ø§Ø± Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØºÛŒØ¨Øª
            if (data.classes && data.classes.length > 0) {
                html += `<div class="stat-card">`;
                html += `<h3>ğŸ“Š Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØºÛŒØ¨Øª</h3>`;
                html += `<div class="bar-chart">`;
                
                const maxClassCount = data.classes[0].count;
                
                data.classes.forEach((c, i) => {
                    const width = (c.count / maxClassCount) * 100;
                    html += `<div class="bar-item">`;
                    html += `<div class="bar-label">${i + 1}. Ù¾Ø§ÛŒÙ‡ ${c.grade} Ú©Ù„Ø§Ø³ ${c.class}</div>`;
                    html += `<div class="bar-visual" style="width: ${width}%">${c.count} Ù†ÙØ±</div>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            }

            if (data.students.length === 0 && data.classes.length === 0) {
                html = '<p class="message info">Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
            }

            contentDiv.innerHTML = html;
        }

        function exportToExcel() {
            if (!currentStatistics || !currentStatistics.students || currentStatistics.students.length === 0) {
                alert('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø¢Ù…Ø§Ø± Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯');
                return;
            }

            // BOM Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ
            let csv = '\ufeff';
            csv += 'Ø±Ø¯ÛŒÙ,Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ,Ù¾Ø§ÛŒÙ‡,Ú©Ù„Ø§Ø³,ØªØ¹Ø¯Ø§Ø¯ ØºÛŒØ¨Øª\n';
            
            currentStatistics.students.forEach((s, index) => {
                csv += `${index + 1},"${s.name}",${s.grade},${s.class},${s.count}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Ø¢Ù…Ø§Ø±_ØºÛŒØ¨Øª_${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('âœ… ÙØ§ÛŒÙ„ Excel Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
        }

        async function addStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            const family = document.getElementById('newStudentFamily').value.trim();
            const grade = document.getElementById('newStudentGrade').value;
            const classNum = document.getElementById('newStudentClass').value;
            const teacher = document.getElementById('newStudentTeacher').value.trim();

            if (!name || !family) {
                showMessage('addStudentMessage', 'Ù„Ø·ÙØ§ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            const result = await callAPI('addStudent', {
                name: name,
                family: family,
                grade: grade,
                class: classNum,
                teacher: teacher
            });

            if (result.success) {
                showMessage('addStudentMessage', 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…', 'success');
                
                students.push({name, family, grade, class: classNum, teacher});
                
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentFamily').value = '';
                document.getElementById('newStudentTeacher').value = '';
                
                setTimeout(() => {
                    document.getElementById('addStudentMessage').classList.add('hidden');
                }, 3000);
            } else {
                showMessage('addStudentMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
            }
        }
    </script>
</body>
</html>

