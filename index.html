<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</title>
    <script src="https://unpkg.com/jdate/jdate.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tahoma', 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; text-align: center; }
        h1 { color: #667eea; margin-bottom: 10px; }
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab-button { background: #f0f0f0; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; color: #333; transition: background 0.3s; border-radius: 8px 8px 0 0; margin: 0 2px; border-bottom: 3px solid transparent; }
        .tab-button.active { background: #fff; color: #667eea; border-bottom: 3px solid #667eea; font-weight: bold; }
        .tab-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; }
        .tab-content.active { display: block; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .date-display { font-size: 18px; font-weight: bold; color: #764ba2; }
        .filter-group { display: flex; gap: 10px; align-items: center; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        #students-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .student-item { background: #f9f9f9; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #eee; transition: border 0.2s; cursor: pointer; }
        .student-item.selected { background: #e6f7ff; border-color: #667eea; }
        .student-info { display: flex; flex-direction: column; align-items: flex-start; }
        .student-name { font-weight: bold; color: #333; font-size: 1.1em; }
        .student-details { font-size: 0.9em; color: #666; margin-top: 5px; }
        .student-index { font-weight: bold; color: #764ba2; margin-left: 10px; }
        button { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.3s, transform 0.1s; }
        button:hover { background: #5a6edb; }
        button:active { transform: scale(0.98); }
        #status-message { margin-top: 20px; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        #manager-report-content { white-space: pre-wrap; font-family: Tahoma, Arial, monospace; background: #f0f0f0; padding: 15px; border-radius: 8px; min-height: 200px; border: 1px solid #ccc; margin-top: 20px; }
        #records-search-tab { display: flex; flex-direction: column; gap: 20px; }
        #records-search-input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; width: 100%; max-width: 400px; margin-left: 10px; }
        .search-controls { display: flex; align-items: center; gap: 10px; }
        #records-search-result { margin-top: 15px; padding: 20px; border-radius: 8px; background: #e6f7ff; border: 1px solid #667eea; min-height: 100px; display: flex; align-items: center; justify-content: center; font-size: 1.1em; color: #333; text-align: center; flex-direction: column; }
        .result-count { font-size: 2.5em; color: #764ba2; font-weight: bold; display: block; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h1>
            <div class="date-display" id="date-display"></div>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('absence-tab')">Ø«Ø¨Øª ØºÛŒØ¨Øª</button>
            <button class="tab-button" onclick="openTab('manager-report-tab')">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±</button>
            <button class="tab-button" onclick="openTab('records-search-tab')">Ú¯Ø²Ø§Ø±Ø´ Ø³ÙˆØ§Ø¨Ù‚</button>
        </div>

        <div id="absence-tab" class="tab-content active">
            <div class="controls">
                <div class="filter-group">
                    <label for="grade-filter">Ù¾Ø§ÛŒÙ‡:</label>
                    <select id="grade-filter"><option value="">Ù‡Ù…Ù‡</option></select>
                </div>
                <div class="filter-group">
                    <label for="class-filter">Ú©Ù„Ø§Ø³:</label>
                    <select id="class-filter"><option value="">Ù‡Ù…Ù‡</option></select>
                </div>
            </div>
            
            <div id="students-list">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†...</div>
            
            <button id="submit-btn" disabled>âœ… Ø«Ø¨Øª ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</button>
            <div id="status-message"></div>
        </div>

        <div id="manager-report-tab" class="tab-content">
            <h2>Ú¯Ø²Ø§Ø±Ø´ ØºØ§ÛŒØ¨ÛŒÙ† Ø§Ù…Ø±ÙˆØ² (Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„)</h2>
            <button id="copy-manager-report-btn" style="margin-top: 15px; background: #28a745;">ğŸ“‹ Ú©Ù¾ÛŒ Ù„ÛŒØ³Øª ØºØ§ÛŒØ¨ÛŒÙ† Ø§Ù…Ø±ÙˆØ²</button>
            <pre id="manager-report-content">Ù„ÛŒØ³Øª ØºØ§ÛŒØ¨ÛŒÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§ Ø¯Ø± ØªØ¨ "Ø«Ø¨Øª ØºÛŒØ¨Øª" ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</pre>
        </div>

        <div id="records-search-tab" class="tab-content">
            <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÙˆØ§Ø¨Ù‚ ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h2>
            <div class="search-controls">
                <input type="text" id="records-search-input" placeholder="Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                <button id="search-records-btn" style="background: #ffc107; color: #333;">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
            </div>
            <div id="records-search-result">Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (ØªØ¹Ø¯Ø§Ø¯ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ) Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>

    </div>

    <script>
        // âš ï¸ Ù…Ù‡Ù…: Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Apps Script Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø¢Ø¯Ø±Ø³ Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx5-XlYeSRCoYnImDxbqqrcTZMFLYvx0g6E1ZkER_wgY1yhvgkQYUyZfbnv2pe6fdyL/exec'; 

        let allStudents = [];
        let selectedStudents = new Set();
        
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'manager-report-tab') { generateManagerReport(); }
            if (tabName === 'records-search-tab') { document.getElementById('records-search-result').innerHTML = 'Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (ØªØ¹Ø¯Ø§Ø¯ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ) Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'; }
        }
        
        async function loadData() {
            try {
                // ğŸ”´ Ù†Ø§Ù… ÙØ§ÛŒÙ„ CSV Ø´Ù…Ø§: list.csv
                const response = await fetch('list.csv'); 
                const csvText = await response.text();
                
                const rows = csvText.split('\n').filter(row => row.trim() !== '').slice(1);
                
                allStudents = rows.map((row) => {
                    // split Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø§Ù…Ø§ (,) ÛŒØ§ Ù†Ù‚Ø·Ù‡ ÙˆÛŒØ±Ú¯ÙˆÙ„ (;) Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø­ÙˆÙ‡ Ø°Ø®ÛŒØ±Ù‡ CSV Ø¯Ø± Ø§Ú©Ø³Ù„
                    // Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ ÙØ±Ø¶ Ù…ÛŒ Ú©Ù†ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø§Ù…Ø§ Ø§Ø³Øª. Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ; ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒÙ….
                    const columns = row.split(',').map(col => col.trim().replace(/"/g, ''));
                    
                    // Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø®ØªØ§Ø± Ø´Ù…Ø§: 0:ID, 1:Ù†Ø§Ù…, 2:Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ, 3:Ù¾Ø§ÛŒÙ‡, 4:Ú©Ù„Ø§Ø³, 5:Ù…Ø¹Ù„Ù…
                    const idIndex = 0;
                    const nameIndex = 1; 
                    const lastNameIndex = 2;
                    const gradeIndex = 3;
                    const classNumberIndex = 4;
                    const teacherIndex = 5;

                    return {
                        id: columns[idIndex] || Math.random(), 
                        firstName: columns[nameIndex] || '',
                        lastName: columns[lastNameIndex] || '',
                        grade: columns[gradeIndex] || '',
                        classNumber: columns[classNumberIndex] || '',
                        teacher: columns[teacherIndex] || ''
                    };
                }).filter(s => s.firstName && s.lastName);

                populateFilters();
                renderStudentsList();

            } catch (error) {
                console.error("Error loading student data:", error);
                document.getElementById('students-list').innerHTML = '<div class="error" style="grid-column: 1 / -1; text-align: center;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²Ø§Ù†. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÙØ§ÛŒÙ„ **list.csv** Ø¯Ø± Ù¾ÙˆØ´Ù‡ public Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯ Ùˆ Ø¨Ø§ **UTF-8** Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>';
            }
        }
        
        function populateFilters() {
            const gradeFilter = document.getElementById('grade-filter');
            const classFilter = document.getElementById('class-filter');
            const grades = new Set(allStudents.map(s => s.grade).filter(g => g));
            const classNumbers = new Set(allStudents.map(s => s.classNumber).filter(c => c));
            
            gradeFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡</option>';
            grades.forEach(grade => { const option = document.createElement('option'); option.value = grade; option.textContent = grade; gradeFilter.appendChild(option); });
            
            classFilter.innerHTML = '<option value="">Ù‡Ù…Ù‡</option>';
            classNumbers.forEach(classNum => { const option = document.createElement('option'); option.value = classNum; option.textContent = classNum; classFilter.appendChild(option); });

            gradeFilter.addEventListener('change', renderStudentsList);
            classFilter.addEventListener('change', renderStudentsList);
        }

        function renderStudentsList() {
            const listContainer = document.getElementById('students-list');
            listContainer.innerHTML = '';
            
            const selectedGrade = document.getElementById('grade-filter').value;
            const selectedClass = document.getElementById('class-filter').value;

            let filteredStudents = allStudents.filter(s => {
                const gradeMatch = !selectedGrade || s.grade === selectedGrade;
                const classMatch = !selectedClass || s.classNumber === selectedClass;
                return gradeMatch && classMatch;
            });

            filteredStudents.sort((a, b) => a.lastName.localeCompare(b.lastName, 'fa'));

            if (filteredStudents.length === 0) {
                listContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #777;">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
                document.getElementById('submit-btn').disabled = true;
                return;
            }

            filteredStudents.forEach((student, index) => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.dataset.studentId = student.id;

                if (selectedStudents.has(student.id)) { item.classList.add('selected'); }

                item.innerHTML = `
                    <div class="student-info">
                        <span class="student-name">${student.firstName} ${student.lastName}</span>
                        <div class="student-details">Ù¾Ø§ÛŒÙ‡: ${student.grade}, Ú©Ù„Ø§Ø³: ${student.classNumber}, Ù…Ø¹Ù„Ù…: ${student.teacher}</div>
                    </div>
                    <span class="student-index">${index + 1}</span>
                `;
                
                item.addEventListener('click', () => toggleSelection(student.id, item));
                listContainer.appendChild(item);
            });

            updateSubmitButtonStatus();
        }

        function toggleSelection(studentId, element) {
            if (selectedStudents.has(studentId)) {
                selectedStudents.delete(studentId);
                element.classList.remove('selected');
            } else {
                selectedStudents.add(studentId);
                element.classList.add('selected');
            }
            updateSubmitButtonStatus();
            if (document.getElementById('manager-report-tab').classList.contains('active')) { generateManagerReport(); }
        }
        
        function updateSubmitButtonStatus() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = selectedStudents.size === 0;
            submitBtn.textContent = selectedStudents.size === 0 
                ? 'âœ… Ø«Ø¨Øª ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡' 
                : `âœ… Ø«Ø¨Øª ØºÛŒØ¨Øª ${selectedStudents.size} Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`;
        }

        document.getElementById('submit-btn').addEventListener('click', async function() {
            const statusMessage = document.getElementById('status-message');
            statusMessage.style.display = 'none';
            this.disabled = true;
            if (selectedStudents.size === 0) return;
            if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_PUBLISHED_URL') { showMessage('âŒ Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø¢Ø¯Ø±Ø³ Apps Script Ø±Ø§ Ø¯Ø± Ú©Ø¯ HTML Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯!', 'error'); this.disabled = false; return; }

            const selectedData = [];
            const currentDate = new JDate().format('yyyy/mm/dd');

            selectedStudents.forEach(id => {
                const student = allStudents.find(s => s.id === id);
                if (student) { selectedData.push({ name: student.firstName, lastName: student.lastName, grade: student.grade, classNumber: student.classNumber, teacher: student.teacher, date: currentDate }); }
            });

            try {
                // ØªÙˆØ¬Ù‡: Ø¯Ø± Ø­Ø§Ù„Øª POST Ø¨Ø§ Apps Script Ø§Ø² no-cors Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ….
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'registerAbsence', data: selectedData })
                });

                showMessage('Ø«Ø¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! ğŸ˜Š', 'success');
                // Ù¾Ø³ Ø§Ø² Ø«Ø¨Øª Ù…ÙˆÙÙ‚ØŒ ØºØ§ÛŒØ¨ÛŒÙ† Ø±Ø§ Ø§Ø² Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ù…ÛŒ Ú©Ù†ÛŒÙ…
                selectedStudents.clear();
                renderStudentsList();

            } catch (error) {
                console.error('Error submitting data:', error);
                showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ Google Sheets! (Ø§ØªØµØ§Ù„ Apps Script Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯)', 'error');
            } finally {
                this.disabled = false;
            }
        });

        function showMessage(message, type) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.style.display = 'block';
            setTimeout(() => { statusMessage.style.display = 'none'; }, 5000);
        }

        function updateDateDisplay() {
            const date = new JDate();
            const formattedDate = date.format('yyyy/mm/dd (W)');
            document.getElementById('date-display').textContent = `ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²: ${formattedDate}`;
        }
        
        function generateManagerReport() {
            const container = document.getElementById('manager-report-content');
            if (selectedStudents.size === 0) { container.textContent = 'âŒ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¨Ø±Ø§ÛŒ ØºÛŒØ¨Øª Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'; return; }

            const absentStudents = Array.from(selectedStudents).map(id => allStudents.find(s => s.id === id)).filter(s => s);
            const currentDate = new JDate().format('yyyy/mm/dd');
            let report = `âœ… Ú¯Ø²Ø§Ø±Ø´ ØºØ§ÛŒØ¨ÛŒÙ† Ù…ÙˆØ±Ø® ${currentDate}:\n\n`;
            
            // Ú¯Ø±ÙˆÙ‡ Ø¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÛŒÙ‡ Ùˆ Ú©Ù„Ø§Ø³
            const grouped = absentStudents.reduce((acc, student) => {
                const key = `Ù¾Ø§ÛŒÙ‡ ${student.grade} / Ú©Ù„Ø§Ø³ ${student.classNumber} (Ù…Ø¹Ù„Ù…: ${student.teacher})`;
                if (!acc[key]) { acc[key] = []; }
                acc[key].push(student);
                return acc;
            }, {});

            Object.keys(grouped).sort().forEach(key => {
                report += `ğŸ“‹ ${key}:\n`;
                grouped[key].sort((a, b) => a.lastName.localeCompare(b.lastName, 'fa'));
                grouped[key].forEach((s, i) => { report += `   ${i + 1}. ${s.firstName} ${s.lastName}\n`; });
                report += `\n`;
            });
            
            report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            report += `ğŸ™ Ù„Ø·ÙØ§Ù‹ Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¬Ù‡Øª Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ù†Ù…Ø§ÛŒÛŒØ¯.`;
            container.textContent = report;
        }

        document.getElementById('copy-manager-report-btn').addEventListener('click', function() {
            const report = document.getElementById('manager-report-content').textContent;
            if (report && !report.includes('âŒ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ')) {
                navigator.clipboard.writeText(report).then(() => { alert('âœ… Ú¯Ø²Ø§Ø±Ø´ ØºØ§ÛŒØ¨ÛŒÙ† Ø§Ù…Ø±ÙˆØ² Ú©Ù¾ÛŒ Ø´Ø¯!'); }).catch(() => { alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.'); });
            } else { alert('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ØºØ§ÛŒØ¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); }
        });

        document.getElementById('search-records-btn').addEventListener('click', async function() {
            const searchName = document.getElementById('records-search-input').value.trim();
            const resultDiv = document.getElementById('records-search-result');
            
            if (searchName.length < 2) { resultDiv.innerHTML = 'Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ Ø¯Ùˆ Ø­Ø±Ù Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'; return; }
            if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_PUBLISHED_URL') { resultDiv.innerHTML = 'âŒ Ø®Ø·Ø§: Ø¢Ø¯Ø±Ø³ Apps Script Ø±Ø§ ÙˆØ§Ø±Ø¯ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.'; return; }

            resultDiv.innerHTML = 'Ø¯Ø±Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÙˆØ§Ø¨Ù‚... âŒ›';

            try {
                const url = APPS_SCRIPT_URL + '?action=getAbsenceCount&name=' + encodeURIComponent(searchName);
                const response = await fetch(url);
                const text = await response.text();
                
                let data;
                try { data = JSON.parse(text); } catch (e) { resultDiv.innerHTML = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² Ø³Ø±ÙˆØ±. (Ø¢Ø¯Ø±Ø³ Apps Script Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯)`; return; }

                if (data.error) { resultDiv.innerHTML = `âŒ Ø®Ø·Ø§: ${data.error}`; } 
                else if (data.count === undefined) { resultDiv.innerHTML = `âŒ Ø®Ø·Ø§: Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯. (Apps Script Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯)`; } 
                else {
                    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ² Ø§Ø² Ù„ÛŒØ³Øª Ù…Ø­Ù„ÛŒ
                    const studentInfo = allStudents.find(s => s.firstName.includes(searchName) || s.lastName.includes(searchName));
                    const studentDisplay = studentInfo 
                        ? `${studentInfo.firstName} ${studentInfo.lastName} (Ù¾Ø§ÛŒÙ‡: ${studentInfo.grade}ØŒ Ú©Ù„Ø§Ø³: ${studentInfo.classNumber}ØŒ Ù…Ø¹Ù„Ù…: ${studentInfo.teacher})` 
                        : searchName;

                    resultDiv.innerHTML = `
                        ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ **${studentDisplay}**:
                        <span class="result-count">${data.count}</span>
                        <p style="font-size: 0.9em; color: #555; margin-top: 10px;">(Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ø§Ø² Ø³ÙˆØ§Ø¨Ù‚ Google Sheets Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.)</p>
                    `;
                }
            } catch (error) {
                console.error('Error fetching records:', error);
                resultDiv.innerHTML = 'âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Apps Script Ø´Ù…Ø§ Ø¯Ø±Ø³Øª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ø­Ø§Ù„Øª "Anyone" Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.';
            }
        });

        updateDateDisplay();
        loadData();
        openTab('absence-tab');
    </script>
</body>

</html>
